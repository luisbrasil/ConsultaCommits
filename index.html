<!DOCTYPE html>
<html lang="pt-br">
<head>
    <link rel="stylesheet" href="style.css">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-COMPATIBLE" content="IE=edge">
    <meta name="viewport" content="width-device-width, initial-scale=1.0">
    <title>Verificação de Commit</title>
</head>
<body>
    <div class="formulario">
        <div class="container">
            <form>
                <label>Repositório</label>
                <input class="input-max" type="text" id="repositorio"/><br/><br/>
                <div class="rows">
                    <div>
                        <label>Data Inicial</label>
                        <input type="date" id="dataInicial"/><br/><br/>
                    </div>
                    <div>
                        <label>Data Final</label>
                        <input type="date" id="dataFinal"/><br/><br/>
                    </div>
                </div>
                <input class="button" type="submit" value="Pesquisar" />
                <table id="tabela" class="table">
                    <caption>Lista de Commits</caption>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Quantidade de Commits</th>
                            <th>Autor</th>
                            <th>Comentários</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </form>
            <div id="dados"></div>
        </div>
    </div>

    <script>
        document.getElementById('dataFinal').valueAsDate = new Date();

        const form = document.querySelector('form');
        form.addEventListener('submit', function(e){
            e.preventDefault();
            const repositorio = document.querySelector('#repositorio').value;
            const dataInicial = document.querySelector('#dataInicial').value;
            const dataFinal = document.querySelector('#dataFinal').value;
            const url = tratarUrl(repositorio);
            buscarCommits(url, dataInicial, dataFinal)
        });

        function buscarCommits(repositorio, dataInicial, dataFinal){
            const url = `https://api.github.com/repos/${repositorio}/commits?since=${dataInicial}&until=${dataFinal}`
            fetch(url).then(response=>response.json()).
            then(commits => {
                contarCommits(commits);
            }).catch(error => {
                console.log(error);
            });
        }
        function contarCommits(commits){
            const commitsPorDia = {};
            commits.forEach(element => {
                const dataCommit = element.commit.author.date.substr(0,10);
                const author = element.commit.author.name;
                const comentario = element.commit.message;
                if(commitsPorDia[dataCommit]){
                    commitsPorDia[dataCommit].quantidade++;
                }else{
                    commitsPorDia[dataCommit] = {quantidade:1, data:dataCommit, author:author, comentario:comentario};
                }
            });

            const commitsPorDiaArray = Object.keys(commitsPorDia).map(dataCommit => {
                return {data:dataCommit, quantidade:commitsPorDia[dataCommit].quantidade, author: commitsPorDia[dataCommit].author, message: commitsPorDia[dataCommit].comentario}
            });

            mostrarTela(commitsPorDiaArray)
        }

        function mostrarTela(commits){
            const dados = document.querySelector("#tabela");
            criaTabela(commits)
        }

        function tratarUrl(url){
            const regex = /^https?:\/\/github.com\/([^/]+)\/([^/]+)/;
            const correspondencias = url.match(regex);
            if (correspondencias) {
                const usuario = correspondencias[1];
                const repositorio = correspondencias[2];
                return usuario + "/" + repositorio;
            }
            const regexSemHttps = /^github.com\/([^/]+)\/([^/]+)/;
            const correspondenciasSemHttps = url.match(regexSemHttps);
            if (correspondenciasSemHttps) {
                const usuario = correspondenciasSemHttps[1];
                const repositorio = correspondenciasSemHttps[2];
                return usuario + "/" + repositorio;
            }
             return url;
        }

        function criaTabela(dados) {
            const tabela = document.querySelector("#tabela");
            // Adiciona as linhas com os dados na tabela
            dados.forEach((commit) => {
                var row = tabela.insertRow(1);

                var cell1 = row.insertCell(0);
                var cell2 = row.insertCell(1);
                var cell3 = row.insertCell(2);
                var cell4 = row.insertCell(3);

                cell1.innerHTML = formataData(commit.data);
                cell2.innerHTML = commit.quantidade;
                cell3.innerHTML = commit.author;
                cell4.innerHTML = commit.message;

            });
        }

        function formataData(dataCommit){
            const data = new Date('2023-03-15');
            const mes = (data.getMonth() + 1).toString().padStart(2, '0');
            const dia = data.getDate().toString().padStart(2, '0');
            const ano = data.getFullYear().toString();
            const dataFormatada = `${mes}/${dia}/${ano}`;
            return dataFormatada;
        }
        
    </script>
</body>
</html>